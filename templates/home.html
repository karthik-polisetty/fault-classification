<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>MMS SatAIlite Dashboard</title>
  <link rel="stylesheet" href="/static/styles.css" />
  <style>
    /* canvases sized to avoid page scroll */
    canvas { width: 100%; height: 220px; background: #0f1115; border-radius: 10px; }
  </style>
</head>
<body>
  <main class="grid">
    <!-- LEFT COLUMN -->
    <aside class="left">
      <!-- Company logo -->
      <div class="brand">
        <img src="/static/img/company_logo.png" alt="Company" class="logo">
      </div>

      <section class="aiBox">
        <h2>AI Analysis</h2>
        <div class="aiRow">
          <div class="icn"><span class="dot" id="statusDot"></span></div>
          <div class="txt">
            <div id="detectedTitle" class="title">Awaiting input…</div>
            <div class="sub">Upload a file or run continuous to analyze vibration patterns</div>
            <div class="dt">
              <div id="currDate">Date: —</div>
              <div id="currTime">Time: —</div>
            </div>
          </div>
        </div>
      </section>

      <section class="rowLite">
        <div class="icn grey"><span class="dot red"></span></div>
        <div class="txt">
          <div class="title">High Vibration Detected</div>
          <div class="sub">Pump A-103 NDE, TX Plant showing abnormal amplitude</div>
          <a class="link" href="#">Investigate →</a>
        </div>
      </section>

      <hr class="sep"/>

      <section class="rowPill">
        <div class="icn grey"></div>
        <div class="txt">
          <div class="title">Maintenance reminder</div>
          <div class="sub">Scheduled maintenance for Turbines in California Plant due in 3 days.</div>
          <a class="link" href="#">Schedule →</a>
        </div>
      </section>

      <hr class="sep"/>

      <section class="rowPill">
        <div class="icn green"></div>
        <div class="txt">
          <div class="title">Efficiency improvement</div>
          <div class="sub">Motor B-205 efficiency improved by 12% after recent adjustments.</div>
          <a class="link" href="#">View details →</a>
        </div>
      </section>

      <!-- CONTROLS -->
      <section class="controls">
        <div class="switch">
          <button id="mode_individual" class="active">Individual</button>
          <button id="mode_continuous">Continuous</button>
        </div>

        <div class="upload" id="uploadRow">
          <input id="fileInput" type="file" accept=".csv,.npy" />
          <label for="fileInput" class="btn">Upload & Predict</label>
        </div>

        <div class="upload" id="continuousRow" style="display:none;">
          <button id="startRun" class="btn">Start</button>
          <button id="stopRun" class="btn">Stop</button>
        </div>
      </section>
    </aside>

    <!-- RIGHT COLUMN -->
    <section class="right">
      <!-- Project logo pinned to top-right -->
      <div class="project-logo">
        <img src="/static/img/project_logo.png" alt="Project" class="logoSmall">
      </div>

      <div class="panel">
        <h3>Time Waveform</h3>
        <div class="axisRow">
          <span class="label">Channel:</span>
          <button class="axis" data-ch="0">IV</button>
          <button class="axis" data-ch="1">IH</button>
          <button class="axis" data-ch="2">OV</button>
          <button class="axis" data-ch="3">OH</button>
        </div>
        <canvas id="timeCanvas" aria-label="Time waveform"></canvas>
      </div>

      <div class="panel">
        <h3>FFT Plot (from file)</h3>
        <div class="axisRow">
          <span class="label">Channel:</span>
          <button class="axis" data-ch="0">IV</button>
          <button class="axis" data-ch="1">IH</button>
          <button class="axis" data-ch="2">OV</button>
          <button class="axis" data-ch="3">OH</button>
        </div>
        <canvas id="fftCanvas" aria-label="FFT"></canvas>
      </div>
    </section>
  </main>

  <script>
    // ===== Labels =====
    const classLabels = { 0: "Normal", 1: "Imbalance", 2: "Misalignment", 3: "Bearing" };
    const detectionText = {
      0: "Normal condition detected",
      1: "Imbalance detected",
      2: "Misalignment detected",
      3: "Bearing fault detected"
    };
    const channelNames = ["IV","IH","OV","OH"];

    // ===== Date/Time =====
    function updateDT(){
      const now = new Date();
      document.getElementById('currDate').textContent =
        "Date: " + now.toLocaleDateString(undefined, {year:"numeric", month:"numeric", day:"numeric"});
      document.getElementById('currTime').textContent =
        "Time: " + now.toLocaleTimeString(undefined, {hour:"2-digit", minute:"2-digit", hour12:true});
    }
    updateDT(); setInterval(updateDT, 60000);

    // ===== Elements & State =====
    const statusDot = document.getElementById('statusDot');
    const detectedTitle = document.getElementById('detectedTitle');

    const fileInput = document.getElementById('fileInput');
    const modeIndividualBtn = document.getElementById('mode_individual');
    const modeContinuousBtn = document.getElementById('mode_continuous');
    const uploadRow = document.getElementById('uploadRow');
    const continuousRow = document.getElementById('continuousRow');
    const startBtn = document.getElementById('startRun');
    const stopBtn = document.getElementById('stopRun');

    let selectedChannel = 0;
    let mode = "individual";
    let ticker = null;
    let samples = [];
    let lastIdx = -1; // avoid immediate repeat

    function setActiveChannel(ch){
      selectedChannel = ch;
      document.querySelectorAll('.axisRow .axis').forEach(btn=>{
        btn.classList.toggle('active', Number(btn.dataset.ch) === selectedChannel);
      });
      if (mode === "individual" && fileInput.files[0]) uploadAndPredict();
    }
    document.querySelectorAll('.axisRow .axis').forEach(btn=>{
      btn.addEventListener('click', ()=> setActiveChannel(Number(btn.dataset.ch)));
    });
    setActiveChannel(0);

    // ===== Drawing =====
    function drawLineSeries(canvas, xArr, yArr, yLabel=""){
      const ctx = canvas.getContext('2d');
      const w = canvas.width  = canvas.clientWidth;
      const h = canvas.height = canvas.clientHeight;

      ctx.clearRect(0,0,w,h);
      ctx.lineWidth = 1.5;

      const xMin = xArr[0], xMax = xArr[xArr.length-1];
      let yMin = Infinity, yMax = -Infinity;
      for (let y of yArr){ if (y < yMin) yMin = y; if (y > yMax) yMax = y; }
      if (yMin === yMax) { yMin -= 1; yMax += 1; }

      const padL = 40, padR = 12, padT = 12, padB = 20;
      const plotW = w - padL - padR, plotH = h - padT - padB;

      const xScale = v => padL + ((v - xMin) / (xMax - xMin)) * plotW;
      const yScale = v => padT + (1 - (v - yMin) / (yMax - yMin)) * plotH;

      ctx.strokeStyle = "rgba(255,255,255,0.2)";
      ctx.beginPath();
      ctx.moveTo(padL, padT); ctx.lineTo(padL, padT+plotH);
      ctx.lineTo(padL+plotW, padT+plotH); ctx.stroke();

      ctx.strokeStyle = "#8ab4f8";
      ctx.beginPath();
      ctx.moveTo(xScale(xArr[0]), yScale(yArr[0]));
      for (let i=1; i<xArr.length; i++){
        ctx.lineTo(xScale(xArr[i]), yScale(yArr[i]));
      }
      ctx.stroke();

      if (yLabel){
        ctx.fillStyle = "rgba(255,255,255,0.7)";
        ctx.font = "12px sans-serif";
        ctx.fillText(yLabel, padL, padT + 12);
      }
    }

    // ===== Individual Mode =====
    fileInput.addEventListener('change', ()=>{
      if (fileInput.files[0]) uploadAndPredict();
    });

    async function uploadAndPredict(){
      const f = fileInput.files[0];
      if (!f) { return; }
      const form = new FormData();
      form.append("file", f);
      form.append("channel", String(selectedChannel));

      try {
        const res = await fetch("/predict-individual/", { method: "POST", body: form });
        if (!res.ok) throw new Error((await res.json()).detail || "Prediction failed.");
        const data = await res.json();
        renderDetection(data);
      } catch (e) {
        renderError(e.message);
      }
    }

    // ===== Continuous Mode =====
    modeIndividualBtn.onclick = () => {
      mode = "individual";
      modeIndividualBtn.classList.add('active');
      modeContinuousBtn.classList.remove('active');
      uploadRow.style.display = "";
      continuousRow.style.display = "none";
      stopLoop();
    };

    modeContinuousBtn.onclick = async () => {
      mode = "continuous";
      modeContinuousBtn.classList.add('active');
      modeIndividualBtn.classList.remove('active');
      uploadRow.style.display = "none";
      continuousRow.style.display = "";
      stopLoop();
      await loadSamples();
    };

    startBtn.onclick = startLoop;
    stopBtn.onclick  = stopLoop;

    async function loadSamples(){
      try {
        const r = await fetch("/samples");
        const j = await r.json();
        samples = (j.samples || []).map(s => s.filename);
        if (!samples.length) renderError("No sample files found in static/samples/");
      } catch (e) {
        renderError("Unable to load samples");
      }
    }

    function startLoop(){
      if (!samples.length) { renderError("No sample files to run"); return; }
      if (ticker) return;
      tick();                         // run immediately
      ticker = setInterval(tick, 1500); // then repeat
    }
    function stopLoop(){
      if (ticker) { clearInterval(ticker); ticker = null; }
    }

    function randIndex(){
      if (!samples.length) return -1;
      if (samples.length === 1) return 0;
      let i;
      do { i = Math.floor(Math.random() * samples.length); } while (i === lastIdx);
      return i;
    }

    async function tick(){
      if (!samples.length) return;
      const i = randIndex();
      if (i < 0) return;
      const filename = samples[i];
      lastIdx = i;
      try {
        const url = `/predict-sample?filename=${encodeURIComponent(filename)}&channel=${selectedChannel}`;
        const res = await fetch(url);
        if (!res.ok) throw new Error((await res.json()).detail || "Prediction failed.");
        const data = await res.json();
        renderDetection(data);
      } catch (e) {
        renderError(e.message);
      }
    }

    // ===== Render helpers =====
    function renderDetection(data){
      detectedTitle.textContent = detectionText[data.predicted_class] || "Result detected";
      statusDot.style.background = (data.predicted_class === 0) ? "#4caf50" : "#8ab4f8";

      // Time waveform
      drawLineSeries(
        document.getElementById("timeCanvas"),
        data.time_series,
        data.signal,
        `${channelNames[selectedChannel]} Amplitude`
      );

      // FFT (if present)
      if (data.fft_magnitude && data.fft_magnitude.length > 0) {
        drawLineSeries(
          document.getElementById("fftCanvas"),
          data.fft_freqs,
          data.fft_magnitude,
          `${channelNames[selectedChannel]} FFT Magnitude (file)`
        );
      }
    }

    function renderError(msg){
      detectedTitle.textContent = msg;
      statusDot.style.background = "#f44336";
    }
  </script>
</body>
</html>
